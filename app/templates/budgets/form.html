{% extends "base.html" %}

{% block title %}{{ title }} — Budget{% endblock %}

{% block content %}
<h1>{{ title }}</h1>

<form method="POST" class="mt-3" style="max-width: 500px;">
  {{ form.hidden_tag() }}

  <div class="mb-3">
    {{ form.payee.label(class="form-label") }}
    {{ form.payee(class="form-control") }}
    {% for error in form.payee.errors %}<div class="text-danger">{{ error }}</div>{% endfor %}
  </div>

  <div class="row mb-3">
    <div class="col">
      {{ form.variability.label(class="form-label") }}
      {{ form.variability(class="form-select") }}
    </div>
    <div class="col">
      {{ form.frequency.label(class="form-label") }}
      {{ form.frequency(class="form-select") }}
    </div>
  </div>

  <div class="row mb-3">
    <div class="col">
      {{ form.date_scheduled.label(class="form-label") }}
      {{ form.date_scheduled(class="form-control", type="date") }}
      {% for error in form.date_scheduled.errors %}<div class="text-danger">{{ error }}</div>{% endfor %}
    </div>
    <div class="col">
      {{ form.budgeted_amount.label(class="form-label") }}
      {{ form.budgeted_amount(class="form-control", step="0.01") }}
      {% for error in form.budgeted_amount.errors %}<div class="text-danger">{{ error }}</div>{% endfor %}
    </div>
  </div>

  <div class="row mb-3">
    <div class="col">
      {{ form.category_id.label(class="form-label") }}
      {{ form.category_id(class="form-select", id="category-select") }}
    </div>
    <div class="col">
      {{ form.subcategory_id.label(class="form-label") }}
      {{ form.subcategory_id(class="form-select", id="subcategory-select") }}
    </div>
  </div>

  <div class="mb-3">
    {{ form.notes.label(class="form-label") }}
    {{ form.notes(class="form-control", rows="3") }}
  </div>

  <div class="mb-3 form-check">
    {{ form.is_active(class="form-check-input") }}
    {{ form.is_active.label(class="form-check-label") }}
  </div>

  <button type="submit" class="btn btn-primary">Save</button>
  <a href="{{ url_for('budgets.list_budgets') }}" class="btn btn-secondary">Cancel</a>
</form>
{% endblock %}

{% block extra_js %}
<script>
  const catSelect = document.getElementById('category-select');
  const subSelect = document.getElementById('subcategory-select');

  catSelect.addEventListener('change', async function() {
    const catId = this.value;
    subSelect.innerHTML = '<option value="">— None —</option>';
    if (!catId) return;

    const resp = await fetch(`{{ url_for('budgets.subcategories_for_category', category_id=0) }}`.replace('/0', '/' + catId));
    const subs = await resp.json();
    subs.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.id;
      opt.textContent = s.name;
      subSelect.appendChild(opt);
    });
  });
</script>
{% endblock %}
