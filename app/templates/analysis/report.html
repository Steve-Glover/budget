{% extends "base.html" %}

{% block title %}{{ period.name }} Report — Budget{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    {% if drill_category %}
    <a href="{{ url_for('analysis.period_report', period_id=period.id) }}" class="text-decoration-none me-2">&larr;</a>
    <h1 class="d-inline">{{ period.name }} &mdash; {{ drill_category.name }}</h1>
    {% else %}
    <h1 class="d-inline">{{ period.name }}</h1>
    {% endif %}
    <small class="text-muted ms-2">{{ period.start_date.strftime('%b %d') }} – {{ period.end_date.strftime('%b %d, %Y') }}</small>
  </div>
  <form method="POST" action="{{ url_for('analysis.recompute_period', period_id=period.id) }}" class="d-inline">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <button type="submit" class="btn btn-sm btn-outline-secondary">&#8635; Recompute</button>
  </form>
</div>

{% if rows %}
{# Summary totals #}
{% set total_budgeted = rows | sum(attribute='budgeted_amount') %}
{% set total_actual   = rows | sum(attribute='actual_amount') %}
{% set total_variance = total_budgeted - total_actual %}

<div class="row g-3 mb-4">
  <div class="col-sm-4">
    <div class="card text-center">
      <div class="card-body">
        <div class="text-muted small">Budgeted</div>
        <div class="fs-4 fw-bold">${{ "%.2f"|format(total_budgeted) }}</div>
      </div>
    </div>
  </div>
  <div class="col-sm-4">
    <div class="card text-center">
      <div class="card-body">
        <div class="text-muted small">Spent</div>
        <div class="fs-4 fw-bold">${{ "%.2f"|format(total_actual) }}</div>
      </div>
    </div>
  </div>
  <div class="col-sm-4">
    <div class="card text-center">
      <div class="card-body">
        <div class="text-muted small">Variance</div>
        <div class="fs-4 fw-bold {% if total_variance >= 0 %}text-success{% else %}text-danger{% endif %}">
          {% if total_variance >= 0 %}+{% endif %}${{ "%.2f"|format(total_variance) }}
        </div>
      </div>
    </div>
  </div>
</div>

{# Category rows with progress bars #}
<div class="list-group">
  {% for row in rows %}
  <div class="list-group-item">
    <div class="d-flex justify-content-between align-items-center mb-1">
      <div>
        {% if not drill_category %}
        <a href="{{ url_for('analysis.period_report', period_id=period.id, category_id=row.category_id) }}"
           class="fw-semibold text-decoration-none">{{ row.category_name }}</a>
        {% else %}
        <span class="fw-semibold">{{ row.category_name }}</span>
        {% endif %}
        <small class="text-muted ms-2">{{ row.transaction_count }} txn{% if row.transaction_count != 1 %}s{% endif %}</small>
      </div>
      <div class="text-end">
        <span class="fw-bold">${{ "%.2f"|format(row.actual_amount) }}</span>
        {% if row.budgeted_amount > 0 %}
        <span class="text-muted small ms-1">/ ${{ "%.2f"|format(row.budgeted_amount) }}</span>
        {% endif %}
        {% if row.variance >= 0 %}
        <span class="badge bg-success ms-1">+${{ "%.2f"|format(row.variance) }}</span>
        {% else %}
        <span class="badge bg-danger ms-1">-${{ "%.2f"|format(row.variance * -1) }}</span>
        {% endif %}
      </div>
    </div>
    {% if row.budgeted_amount > 0 %}
    {% set pct = row.pct if row.pct is not none else 0 %}
    {% if pct <= 75 %}{% set bar_class = "bg-success" %}
    {% elif pct <= 100 %}{% set bar_class = "bg-warning" %}
    {% else %}{% set bar_class = "bg-danger" %}{% endif %}
    <div class="progress" style="height: 8px;">
      <div class="progress-bar {{ bar_class }}" role="progressbar"
           style="width: {{ [pct, 100] | min }}%"
           aria-valuenow="{{ pct }}" aria-valuemin="0" aria-valuemax="100"></div>
    </div>
    <div class="text-end">
      <small class="text-muted">{{ pct }}%</small>
    </div>
    {% endif %}
  </div>
  {% endfor %}
</div>

{% else %}
<div class="alert alert-info">
  No analysis data for this period.
  {% if not drill_category %}
  Use the <strong>Recompute</strong> button to generate a report from current transactions and budgets.
  {% endif %}
</div>
{% endif %}

<div class="mt-3">
  <a href="{{ url_for('analysis.list_periods') }}" class="btn btn-outline-secondary btn-sm">&larr; All Periods</a>
</div>
{% endblock %}
